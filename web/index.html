<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Platogram - Transform Audio into Actionable Knowledge</title>
    <script src="https://cdn.auth0.com/js/auth0-spa-js/2.0/auth0-spa-js.production.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500&display=swap" rel="stylesheet" />
    <link rel="stylesheet" href="styles.css">
  </head>
  <body>
    <div class="container">
      <header>
        <a href="#" class="cta" onclick="login()" id="login-button">Log In</a>
        <a href="#" class="cta" onclick="logout()" id="logout-button">Log Out</a>
        <a href="#" class="cta" onclick="testAuth()" id="test-auth-button">Test Auth</a>
      </header>

      <main>
        <h1>Transform Speech into Knowledge</h1>

        <div id="input-section" class="cta-container">
          <p>
            Convert hours of audio into structured, readable documents
          </p>
          <div class="input-wrapper">
            <input type="text" id="url-input" placeholder="Link to YouTube, Google Drive, audio, transcript, or upload" />
            <label for="file-upload" class="upload-button">
              <span class="upload-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                  <polyline points="17 8 12 3 7 8"></polyline>
                  <line x1="12" y1="3" x2="12" y2="15"></line>
                </svg>
              </span>
              <input
                type="file"
                id="file-upload"
                accept=".srt,.wav,.ogg,.vtt,.mp3,.mp4,.m4a"
                style="display: none"
                onchange="onConvertClick()"
              />
            </label>
          </div>
          <a href="#" class="cta" onclick="onConvertClick()">Convert</a>
          <a href="#" class="cta donate" onclick="onDonateClick()">Donate</a>
        </div>

        <div id="done-section" class="cta-container hidden">
          <div class="success-icon">&#10004;</div>
          <p>
            Done! Please check your e-mail inbox in a few minutes.
          </p>
          <button onclick="reset()" class="cta">Got it!</button>
        </div>
        <div id="status-section" class="cta-container hidden">
          <p>
            Working on it. You will receive an email from Artyom Astafurov with
            PDF, Word, and Markdown documents once ready.
          </p>
          <p>
            Processing time is quick - about 5 mins for each hour of content. Hang tight!
          </p>
          <div id="animation-container">
            <div id="runner"></div>
            <p id="processing-stage"></p>
          </div>
          <button class="cta donate" onclick="onDonateClick()">Donate</button>
          <!-- <button onclick="reset()">Cancel</button> -->
        </div>
        <script>
          const processingStages = [
            "Byte Whispering", "Qubit Juggling", "Syntax Gymnastics",
            "Pixel Wrangling", "Neuron Tickling", "Algorithm Disco",
            "Data Origami", "Bit Barbecue", "Logic Limbo",
            "Quantum Knitting"
          ];
          let currentStageIndex = 0;
          
          function updateProcessingStage() {
            document.getElementById('processing-stage').textContent = processingStages[currentStageIndex];
            currentStageIndex = (currentStageIndex + 1) % processingStages.length;
          }
        
          setInterval(updateProcessingStage, 3000);
          updateProcessingStage(); // Initial update
        </script>
        <div id="error-section" class="cta-container hidden">
          <p>An error occurred. Please try again.</p>
          <button onclick="reset()" class="cta">Reset</button>
        </div>

        <!-- Rest of the HTML content remains the same -->

      </main>
      <footer>
        <p>
          Platogram is built with ðŸ’œ in New York and Boston by

            href="https://codeanyway.com"
            target="_blank"
            rel="noopener noreferrer"
            >Code Anyway, Inc</a
          >
          in 2023-2024
        </p>
      </footer>
    </div>
    <script>
      let auth0Client = null;

      // Initialize Auth0
      async function initAuth0() {
        try {
          auth0Client = await auth0.createAuth0Client({
            domain: "dev-w0dm4z23pib7oeui.us.auth0.com",
            clientId: "iFAGGfUgqtWx7VuuQAVAgABC1Knn7viR",
            authorizationParams: {
              redirect_uri: window.location.origin,
              audience: "https://platogram.vercel.app/",
              scope: "openid profile email",
            },
            cacheLocation: "localstorage",
            // useRefreshTokens: true,
          });
          console.log("Auth0 client initialized successfully");

          // Check for the code and state parameters
          const query = window.location.search;
          if (query.includes("code=") && query.includes("state=")) {
            await auth0Client.handleRedirectCallback();
            window.history.replaceState({}, document.title, "/");
          }

          await updateUI();
        } catch (error) {
          console.error("Error initializing Auth0:", error);
        }
      }

      function updateUIStatus(status, errorMessage = "") {
        const inputSection = document.getElementById("input-section");
        const statusSection = document.getElementById("status-section");
        const errorSection = document.getElementById("error-section");
        const doneSection = document.getElementById("done-section");

        inputSection.classList.add("hidden");
        statusSection.classList.add("hidden");
        errorSection.classList.add("hidden");
        doneSection.classList.add("hidden");

        switch (status) {
          case "running":
            statusSection.classList.remove("hidden");
            break;
          case "done":
            doneSection.classList.remove("hidden");
            break;
          case "idle":
            inputSection.classList.remove("hidden");
            break;
          case "error":
            errorSection.classList.remove("hidden");
            errorSection.querySelector("p").textContent =
              errorMessage || "An error occurred. Please try again.";
            break;
        }
      }

      // Update UI based on authentication state
      async function updateUI() {
        const isAuthenticated = await auth0Client.isAuthenticated();
        document
          .getElementById("login-button")
          .classList.toggle("hidden", isAuthenticated);
        document
          .getElementById("logout-button")
          .classList.toggle("hidden", !isAuthenticated);

        if (isAuthenticated) {
          const user = await auth0Client.getUser();
          const token = await auth0Client.getTokenSilently({
            audience: "https://platogram.vercel.app",
          });
          pollStatus(token);
          console.log("Logged in as:", user.email);
        }
      }

      async function reset() {
        try {
          const token = await auth0Client.getTokenSilently({
            audience: "https://platogram.vercel.app",
          });

          // Call the /reset endpoint
          const response = await fetch("/reset", {
            method: "GET",
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });

          if (!response.ok) {
            throw new Error("Failed to reset");
          }

          // Clear input fields
          document.getElementById("url-input").value = "";

          // Poll status after reset
          pollStatus(token);
        } catch (error) {
          console.error("Error resetting:", error);
          updateUIStatus("error", "Failed to reset. Please try again.");
        }
      }

      async function onDonateClick() {
        // Open Stripe payment link in a new tab
        window.open("https://buy.stripe.com/eVa29p3PK5OXbq84gl", "_blank");
      }

      // Handle the 'Convert' button click
      async function onConvertClick() {
        const inputData = getInputData();
        if (await auth0Client.isAuthenticated()) {
          // Create and show the language selection modal
          const modal = document.createElement('div');
          modal.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
          `;

          const modalContent = document.createElement('div');
          modalContent.style.cssText = `
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            text-align: center;
          `;

          modalContent.innerHTML = `
            <h3>Select Language</h3>
            <button id="en-btn">English</button>
            <button id="es-btn">Spanish</button>
            <button id="cancel-btn">Cancel</button>
          `;

          modal.appendChild(modalContent);
          document.body.appendChild(modal);

          // Handle language selection
          const handleLanguageSelection = async (lang) => {
            document.body.removeChild(modal);
            await postToConvert(inputData, lang);
          };

          document.getElementById('en-btn').onclick = () => handleLanguageSelection('en');
          document.getElementById('es-btn').onclick = () => handleLanguageSelection('es');
          document.getElementById('cancel-btn').onclick = () => document.body.removeChild(modal);
          // await postToConvert(inputData);
        } else {
          login();
        }
      }

      // Get input data (URL or File)
      function getInputData() {
        const urlInput = document.getElementById("url-input").value;
        const fileInput = document.getElementById("file-upload").files[0];
        return urlInput || fileInput;
      }

      // Login
      async function login() {
        try {
          await auth0Client.loginWithRedirect({
            authorizationParams: {
              redirect_uri: window.location.origin,
            },
          });
        } catch (error) {
          console.error("Error logging in:", error);
        }
      }

      // Logout
      async function logout() {
        try {
          await auth0Client.logout({
            logoutParams: {
              returnTo: window.location.origin,
            },
          });
        } catch (error) {
          console.error("Error logging out:", error);
        }
      }

      async function postToConvert(inputData, lang) {
        let body;
        let headers = {
          Authorization: `Bearer ${await auth0Client.getTokenSilently({
            audience: "https://platogram.vercel.app",
          })}`,
        };

        const formData = new FormData();
        formData.append('lang', lang);

        if (inputData instanceof File) {
          formData.append('file', inputData);
        } else {
          formData.append("payload", inputData);
        }

        body = formData;
        
        try {
          const token = await auth0Client.getTokenSilently({
            audience: "https://platogram.vercel.app",
          });
          const response = await fetch("/convert", {
            method: "POST",
            headers: headers,
            body: body,
          });
          const result = await response.json();

          if (result.message === "Conversion started") {
            pollStatus(token);
          } else {
            updateUIStatus("error", "Unexpected response from server");
          }
        } catch (error) {
          console.error("Error:", error);
          updateUIStatus("error", error);
        }
      }

      async function pollStatus(token) {
        try {
          const response = await fetch("/status", {
            headers: {
              Authorization: `Bearer ${token}`,
            },
          });
          const result = await response.json();

          if (result.status === "running") {
            updateUIStatus("running");
            setTimeout(() => pollStatus(token), 5000); // Poll every 5 seconds
          } else if (result.status === "idle") {
            updateUIStatus("idle");
          } else if (result.status === "failed") {
            updateUIStatus("failed", result.error);
          } else if (result.status === "done") {
            updateUIStatus("done");
          } else {
            updateUIStatus("failed", response.error);
          }
        } catch (error) {
          console.error("Error polling status:", error);
          updateUIStatus("error", error);
        }
      }

      // Initialize the app
      initAuth0().catch((error) =>
        console.error("Error initializing app:", error)
      );
    </script>
    <!-- Start of LiveChat (www.livechat.com) code -->
    <script>
      window.__lc = window.__lc || {};
      window.__lc.license = 18397149;
      window.__lc.integration_name = "manual_onboarding";
      window.__lc.product_name = "livechat";
      (function (n, t, c) {
        function i(n) {
          return e._h ? e._h.apply(null, n) : e._q.push(n);
        }
        var e = {
          _q: [],
          _h: null,
          _v: "2.0",
          on: function () {
            i(["on", c.call(arguments)]);
          },
          once: function () {
            i(["once", c.call(arguments)]);
          },
          off: function () {
            i(["off", c.call(arguments)]);
          },
          get: function () {
            if (!e._h)
              throw new Error(
                "[LiveChatWidget] You can't use getters before load."
              );
            return i(["get", c.call(arguments)]);
          },
          call: function () {
            i(["call", c.call(arguments)]);
          },
          init: function () {
            var n = t.createElement("script");
            (n.async = !0),
              (n.type = "text/javascript"),
              (n.src = "https://cdn.livechatinc.com/tracking.js"),
              t.head.appendChild(n);
          },
        };
        !n.__lc.asyncInit && e.init(),
          (n.LiveChatWidget = n.LiveChatWidget || e);
      })(window, document, [].slice);
    </script>
    <noscript
      ><a href="https://www.livechat.com/chat-with/18397149/" rel="nofollow"
        >Chat with us</a
      >, powered by
      <a
        href="https://www.livechat.com/?welcome"
        rel="noopener nofollow"
        target="_blank"
        >LiveChat</a
      ></noscript
    >
    <!-- End of LiveChat code -->
  </body>
</html>
